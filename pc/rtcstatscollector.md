# statscollector和rtcstatscollector

## 1. statstypes

### 1.1 StatsType

类型|描述|含义
-|-|-
kStatsReportTypeSession|googSession|会话的统计信息
kStatsReportTypeTransport|googTransport|传输的统计信息
kStatsReportTypeComponent|googComponent|channel或者ice组件的统计信息
kStatsReportTypeCandidatePair|googCandidatePair|connection（源/目的端口对）或者candidate pair的统计信息
kStatsReportTypeBwe|VideoBWE|视频带宽估计统计信息
kStatsReportTypeSsrc|ssrc|ssrc代表的rtp流的统计信息
kStatsReportTypeRemoteSsrc|remoteSsrc|remoteSsrc代表的rtp流的统计信息
kStatsReportTypeTrack|googTrack|track的统计信息
kStatsReportTypeIceLocalCandidate|localcandidate|本地candidate的统计信息
kStatsReportTypeIceRemoteCandidate|remotecandidate|远端candidate的统计信息
kStatsReportTypeCertificate|googCertificate|ssl认证的统计信息
kStatsReportTypeDataChannel|datachannel|data channel的统计信息

### 1.2 StatsValueName

类型|描述
-|-
kStatsValueNameActiveConnection|googAccelerateRate
kStatsValueNameAecDivergentFilterFraction|aecDivergentFilterFraction
kStatsValueNameAudioInputLevel|audioInputLevel
kStatsValueNameAudioOutputLevel|audioOutputLevel
kStatsValueNameBytesReceived|bytesReceived
kStatsValueNameBytesSent|bytesSent
kStatsValueNameCodecImplementationName|codecImplementationName
kStatsValueNameConcealedSamples|concealedSamples
kStatsValueNameConcealmentEvents|concealmentEvents
kStatsValueNameDataChannelId|datachannelid
kStatsValueNameFramesDecoded|framesDecoded
kStatsValueNameFramesEncoded|framesEncoded
kStatsValueNameJitterBufferDelay|jitterBufferDelay
kStatsValueNameMediaType|mediaType
kStatsValueNamePacketsLost|packetsLost
kStatsValueNameFractionLost|fractionLost
kStatsValueNamePacketsReceived|packetsReceived
kStatsValueNamePacketsSent|packetsSent
kStatsValueNameProtocol|protocol
kStatsValueNameQpSum|qpSum
kStatsValueNameReceiving|googReadable
kStatsValueNameSelectedCandidatePairId|selectedCandidatePairId
kStatsValueNameSsrc|ssrc
kStatsValueNameState|state
kStatsValueNameTotalAudioEnergy|totalAudioEnergy
kStatsValueNameTotalSamplesDuration|totalSamplesDuration
kStatsValueNameTotalSamplesReceived|totalSamplesReceived
kStatsValueNameTransportId|transportId
kStatsValueNameSentPingRequestsTotal|requestsSent
kStatsValueNameSentPingRequestsBeforeFirstResponse|consentRequestsSent
kStatsValueNameSentPingResponses|responsesSent
kStatsValueNameRecvPingRequests|requestsReceived
kStatsValueNameRecvPingResponses|responsesReceived
kStatsValueNameSentStunKeepaliveRequests|stunKeepaliveRequestsSent
kStatsValueNameRecvStunKeepaliveResponses|stunKeepaliveResponsesReceived
kStatsValueNameStunKeepaliveRttTotal|stunKeepaliveRttTotal
kStatsValueNameStunKeepaliveRttSquaredTotal|stunKeepaliveRttSquaredTotal
以下是内部统计的内容|
kStatsValueNameAccelerateRate|googAccelerateRate
kStatsValueNameActualEncBitrate|googActualEncBitrate
kStatsValueNameAdaptationChanges|googAdaptationChanges
kStatsValueNameAvailableReceiveBandwidth|googAvailableReceiveBandwidth
kStatsValueNameAvailableSendBandwidth|googAvailableSendBandwidth
kStatsValueNameAvgEncodeMs|googAvgEncodeMs
kStatsValueNameBandwidthLimitedResolution|googBandwidthLimitedResolution
kStatsValueNameBucketDelay|googBucketDelay
kStatsValueNameCaptureStartNtpTimeMs|googCaptureStartNtpTimeMs
kStatsValueNameCandidateIPAddress|ipAddress
kStatsValueNameCandidateNetworkType|networkType
kStatsValueNameCandidatePortNumber|portNumber
kStatsValueNameCandidatePriority|priority
kStatsValueNameCandidateTransportType|transport
kStatsValueNameCandidateType|candidateType
kStatsValueNameChannelId|googChannelId
kStatsValueNameCodecName|googCodecName
kStatsValueNameComponent|googComponent
kStatsValueNameContentName|googContentName
kStatsValueNameContentType|googContentType
kStatsValueNameCpuLimitedResolution|googCpuLimitedResolution
kStatsValueNameCurrentDelayMs|googCurrentDelayMs
kStatsValueNameDecodeMs|googDecodeMs
kStatsValueNameDecodingCNG|googDecodingCNG
kStatsValueNameDecodingCTN|googDecodingCTN
kStatsValueNameDecodingCTSG|googDecodingCTSG
kStatsValueNameDecodingMutedOutput|googDecodingMuted
kStatsValueNameDecodingNormal|googDecodingNormal
kStatsValueNameDecodingPLC|googDecodingPLC
kStatsValueNameDecodingPLCCNG|googDecodingPLCCNG
kStatsValueNameDer|googDerBase64
kStatsValueNameDtlsCipher|dtlsCipher
kStatsValueNameEchoDelayMedian|googEchoCancellationEchoDelayMedian
kStatsValueNameEchoDelayStdDev|googEchoCancellationEchoDelayStdDev
kStatsValueNameEchoReturnLoss|googEchoCancellationReturnLoss
kStatsValueNameEchoReturnLossEnhancement|googEchoCancellationReturnLossEnhancement
kStatsValueNameEncodeUsagePercent|googEncodeUsagePercent
kStatsValueNameExpandRate|googExpandRate
kStatsValueNameFingerprint|googFingerprint
kStatsValueNameFingerprintAlgorithm|googFingerprintAlgorithm
kStatsValueNameFirsReceived|googFirsReceived
kStatsValueNameFirsSent|googFirsSent
kStatsValueNameFrameHeightInput|googFrameHeightInput
kStatsValueNameFrameHeightReceived|googFrameHeightReceived
kStatsValueNameFrameHeightSent|googFrameHeightSent
kStatsValueNameFrameRateDecoded|googFrameRateDecoded
kStatsValueNameFrameRateInput|googFrameRateInput
kStatsValueNameFrameRateOutput|googFrameRateOutput
kStatsValueNameFrameRateReceived|googFrameRateReceived
kStatsValueNameFrameRateSent|googFrameRateSent
kStatsValueNameFrameWidthInput|googFrameWidthInput
kStatsValueNameFrameWidthReceived|googFrameWidthReceived
kStatsValueNameFrameWidthSent|googFrameWidthSent
kStatsValueNameHasEnteredLowResolution|googHasEnteredLowResolution
kStatsValueNameHugeFramesSent|hugeFramesSent
kStatsValueNameInitiator|googInitiator
kStatsValueNameInterframeDelayMaxMs|googInterframeDelayMax
kStatsValueNameIssuerId|googIssuerId
kStatsValueNameJitterBufferMs|googJitterBufferMs
kStatsValueNameJitterReceived|googJitterReceived
kStatsValueNameLabel|label
kStatsValueNameLocalAddress|googLocalAddress
kStatsValueNameLocalCandidateId|localCandidateId
kStatsValueNameLocalCandidateType|googLocalCandidateType
kStatsValueNameLocalCertificateId|localCertificateId
kStatsValueNameMaxDecodeMs|googMaxDecodeMs
kStatsValueNameMinPlayoutDelayMs|googMinPlayoutDelayMs
kStatsValueNameNacksReceived|googNacksReceived
kStatsValueNameNacksSent|googNacksSent
kStatsValueNamePlisReceived|googPlisReceived
kStatsValueNamePlisSent|googPlisSent
kStatsValueNamePreemptiveExpandRate|googPreemptiveExpandRate
kStatsValueNamePreferredJitterBufferMs|googPreferredJitterBufferMs
kStatsValueNameRemoteAddress|googRemoteAddress
kStatsValueNameRemoteCandidateId|remoteCandidateId
kStatsValueNameRemoteCandidateType|googRemoteCandidateType
kStatsValueNameRemoteCertificateId|remoteCertificateId
kStatsValueNameRenderDelayMs|googRenderDelayMs
kStatsValueNameResidualEchoLikelihood|googResidualEchoLikelihood
kStatsValueNameResidualEchoLikelihoodRecentMax|googResidualEchoLikelihoodRecentMax
kStatsValueNameAnaBitrateActionCounter|googAnaBitrateActionCounter
kStatsValueNameAnaChannelActionCounter|googAnaChannelActionCounter
kStatsValueNameAnaDtxActionCounter|googAnaDtxActionCounter
kStatsValueNameAnaFecActionCounter|googAnaFecActionCounter
kStatsValueNameAnaFrameLengthIncreaseCounter|googAnaFrameLengthIncreaseCounter
kStatsValueNameAnaFrameLengthDecreaseCounter|googAnaFrameLengthDecreaseCounter
kStatsValueNameAnaUplinkPacketLossFraction|googAnaUplinkPacketLossFraction
kStatsValueNameRetransmitBitrate|googRetransmitBitrate
kStatsValueNameRtt|googRtt
kStatsValueNameSecondaryDecodedRate|googSecondaryDecodedRate
kStatsValueNameSecondaryDiscardedRate|googSecondaryDiscardedRate
kStatsValueNameSendPacketsDiscarded|packetsDiscardedOnSend
kStatsValueNameSpeechExpandRate|googSpeechExpandRate
kStatsValueNameSrtpCipher|srtpCipher
kStatsValueNameTargetDelayMs|googTargetDelayMs
kStatsValueNameTargetEncBitrate|googTargetEncBitrate
kStatsValueNameTimingFrameInfo|googTimingFrameInfo
kStatsValueNameTrackId|googTrackId
kStatsValueNameTransmitBitrate|googTransmitBitrate
kStatsValueNameTransportType|googTransportType
kStatsValueNameTypingNoiseState|googTypingNoiseState
kStatsValueNameWritable|googWritable

### 1.3 StatsReport

* StatsReport类是统计的承载类，其中构造函数StatsReport(const Id& id)根据id创建不同StatsType的StatsReport。Id的创建可以采用类静态函数：
  * 如NewBandwidthEstimationId()，NewTypedId(StatsType type, const std::string& id)等
* 可以根据需要添加不同类型的统计信息，包括：string, int64, int, float, bool等常见类型，StatsValueName参考上述的表格
* 内部会保存多个类型的StatsReport，保存在一个vector中
* 在statscollector中使用StatsCollection进行操作

## 2. StatsCollector

核心流程：  

1. 在PeerConnection::Initialize函数中创建StatsCollector对象stats_
2. 在PeerConnection::AddStream时会调用stats_->AddStream，并创建stream中audio/video track对应的StatsReport
3. 在PeerConnection::AddTrack时会调用stats_->AddTrack，并创建对应的track的StatsReport
4. 在PeerConnection::GetStats/PeerConnection::ApplyLocalDescription/PeerConnection::ApplyRemoteDescription/PeerConnection::Close时会调用stats_->UpdateStats，更新相关的参数，包括session, bwe, media, data, track等几乎所有的参数

## 3. RTCStatsCollector

核心流程：但是这个对象的接口的参数获取与上述是不同流程，是另外一套独立的流程。参数的定义见:rtcstats_objects.h

1. 在PeerConnection::Initialize函数中创建RTCStatsCollector对象stats_collector_
2. 在PeerConnection::GetStats时会调用stats_collector_->GetStatsReport，并通过回调callback异步输出
3. 在PeerConnection::ClearStatsCache时会调用stats_collector_->ClearCachedStatsReport清除缓存
